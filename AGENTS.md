# AGENTS.md

---

## 核心不可变原则

1. **语言规范**：全程中文思维、中文表述，代码注释/文档/响应全部用简体中文
2. **质量第一**：质量与安全不妥协，禁止占位/MVP/TODO
3. **思考先行**：编码前先分析规划，优先根因分析而非打补丁
4. **工具优先**：优先使用经过验证的工具链与官方/标准库组件
5. **透明记录**：关键决策、变更可追溯
6. **持续改进**：从每次执行中复盘优化
7. **结果导向**：以目标达成评判

## 核心开发原则

1. **Context7 自动使用**：代码生成、库文档查询、新库使用、API 报错时触发
2. **重构触发**：函数 >50 行 / 嵌套 >3 层 / 重复代码 >3 次必须重构
3. **设计优先级**：依赖注入 > 工厂模式 > 继承，遵循 SOLID/DRY/关注点分离/YAGNI

## 任务执行流程

1. **检索优先**：回答问题或执行任务前，必须先检索相关代码/文件
2. **需求澄清**：通过多角度提问明确需求，并确认理解
3. **精准定位**：基于检索结果定位需改动的代码
4. **信息充分性判断**：信息不足时继续检索或提问
5. **方案讲解**：对修改计划进行清晰讲解，必要时给伪代码

## 质量与性能标准

- **架构设计**：遵循 SOLID、DRY、关注点分离，避免过度设计但拒绝 YAGNI 破坏扩展性
- **代码质量**：清晰命名、合理抽象，保留必要中文注释，删除无用代码
- **代码风格**：**禁止在代码注释中使用任何 emoji 符号**（包括但不限于"# ✅""# ❌""# 🔧"等）
- **性能意识**：评估时间/空间复杂度，优化 IO/内存，处理边界与异常
- **完整实现**：禁止半成品和兼容性僵尸代码
- **测试约束**：可测试设计，单测覆盖；后台单元测试运行不得超过 60s

## Python 后端

1. **类型检查**：所有代码必须通过 Pyright 零错误检查
2. **导入规范**：禁止 `from src.xxx` 前缀
3. **虚拟环境**：使用根目录 `.venv/`
4. **规则配置**：`apps/backend/pyproject.toml`
5. **每次修改后检查**:
    - `ruff format apps/backend/src/ && ruff check --fix apps/backend/src/`
    - `pyright apps/backend/src/`
    - 遇到问题使用 Exa 查询最佳处理方式
    - 不允许使用 `# type: ignore` 等忽略或取巧处理

## React 前端

1. **类型安全**：禁止使用 `any` 类型
2. **Hooks 规范**：所有依赖必须声明
3. **构建验证**：`pnpm run build` 必须成功
4. **每次修改后检查**:
    - `pnpm --filter @bridgetalk/frontend exec tsc -b --noEmit`
    - `pnpm --filter @bridgetalk/frontend lint`
    - 遇到问题使用 Exa 查询最佳处理方式
    - 不允许使用 `@ts-ignore` 或 `eslint-disable` 等忽略处理

---

## 项目结构

```
bridgetalk/
├── apps/
│   ├── backend/          # Python FastAPI (localhost:8000)
│   │   ├── src/          # 源代码
│   │   ├── alembic/      # 数据库迁移
│   │   └── config.yaml   # 配置文件
│   └── frontend/         # React 前端 (localhost:5173)
└── .claude/rules/        # Claude Code 规则
```

## 🔍 工具使用指南

- Context7（文档检索）：专用于获取库/框架的最新官方文档与代码示例。先用 resolve-library-id，再用 get-library-docs，调用需带 topic/tokens，并在产出中标明库 ID、版本与引用出处。不要用来做通用网页搜索。
- Exa Search（实时网页检索）：专用于实时网页/新闻/博客/公告/社区问答等开放互联网搜索，聚焦时效性与权威性。使用时控制关键词（3-6 个）、返回标题+简述+URL+抓取时间，说明排序依据（相关度/时效），优先官方或高可信来源。

## ⚠️ 高风险操作确认

删除/移动文件、批量改动、系统/权限/环境变量变更、数据库结构/批量数据、git commit/push/reset、网络敏感请求、全局依赖安装等操作前需获得明确确认。

## 📝 文档优先级

1. **用户明确要求** > 一切
2. **CLAUDE.md 与 rules/** > 其他规范
3. **README.md** > 外部最佳实践
4. **Context7、Exa 最新文档** > AI 内置知识
